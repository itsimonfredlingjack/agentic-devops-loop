---
description: Complete task - verify tests/lint, commit, push, create PR, update Jira
---

# Finish Task

Complete the current task - verify all criteria, commit, push, create PR, and update Jira.

## Instructions

Execute these steps in order:

### 1. Read Current Task

```bash
cat docs/CURRENT_TASK.md
```

Extract:
- `JIRA_ID` (e.g., PROJ-123)
- `branch_name` (e.g., feature/PROJ-123-add-login)

If no active task found, abort with error.

### 2. Verify Tests Pass

```bash
# Python projects
pytest -v

# Node projects
npm test
```

**If tests fail: DO NOT proceed.** Fix the failing tests first.

### 3. Verify Lint Passes

```bash
# Python projects
ruff check .

# Node projects
npm run lint
```

**If lint fails: DO NOT proceed.** Fix the linting issues first.

### 4. Verify Acceptance Criteria

Review each acceptance criterion in `docs/CURRENT_TASK.md`.

All checkboxes in the "Exit Criteria" section must be checked:
- [ ] All acceptance criteria met
- [ ] All tests pass
- [ ] No linting errors
- [ ] Changes committed
- [ ] Branch pushed

If any are unchecked, address them before continuing.

### 5. Final Commit

If there are uncommitted changes:

```bash
git add -A
git status
git commit -m "{JIRA_ID}: Final implementation - all tests pass"
```

### 6. Push to Remote

```bash
git push -u origin {branch_name}
```

### 7. Create Pull Request

Use gh CLI:

```bash
gh pr create \
  --title "[{JIRA_ID}] {summary}" \
  --body "## Summary

Implements {JIRA_ID}

## Changes

{list key changes}

## Testing

- [x] Unit tests pass
- [x] Integration tests pass (if applicable)
- [x] Linting passes

## Jira

[{JIRA_ID}]($JIRA_URL/browse/{JIRA_ID})

---
ðŸ¤– *Generated by Claude Code Agent*"
```

Capture the PR URL from output.

### 7b. Notify Monitor - PR Created

Update the monitor to show the Jules Review step:

```bash
python3 -c "
import sys; sys.path.insert(0, '.claude/utils')
from monitor_client import send_task_update
send_task_update('{JIRA_ID}', step=4, step_name='Jules Review', step_desc='PR created, awaiting review...')
import time; time.sleep(0.5)
"
```

### 8. Update Jira

Transition to "In Review":
```
python3 .claude/utils/jira_api.py transition-issue "{JIRA_ID}" "In Review"
```

Add completion comment:
```
python3 .claude/utils/jira_api.py add-comment "{JIRA_ID}" "ðŸ¤– Implementation complete!\n\n**Branch:** `{branch_name}`\n**PR:** {pr_url}\n\nAll tests pass. Ready for review."
```

### 9. Update CURRENT_TASK.md

Mark the task as complete:

```markdown
## Active Task

**Jira ID:** {JIRA_ID}
**Status:** âœ… Complete - In Review
**Branch:** {branch_name}
**PR:** {pr_url}
**Completed:** {timestamp}
```

### 10. Output Completion

Display summary:

```
âœ… Task {JIRA_ID} completed successfully!

Branch: {branch_name}
PR: {pr_url}
Status: In Review

All acceptance criteria met.
All tests pass.
All lint checks pass.

<promise>DONE</promise>
```

---

## Error Handling

| Error | Action |
|-------|--------|
| Tests fail | Fix tests, do NOT proceed |
| Lint fails | Fix issues, do NOT proceed |
| Push fails | Check for conflicts, resolve |
| PR creation fails | Check `gh auth status` |
| Jira update fails | Log warning, continue (non-blocking) |

---

## Important

Only run this command when:
1. All acceptance criteria are met
2. All tests pass
3. All linting passes
4. Implementation is complete

The `<promise>DONE</promise>` triggers the stop-hook to allow exit.
