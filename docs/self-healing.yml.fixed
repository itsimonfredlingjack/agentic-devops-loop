name: Self-Healing Pipeline

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: read

jobs:
  analyze-failure:
    name: Analyze CI Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    permissions:
      contents: write
      pull-requests: write
      actions: read

    outputs:
      should_attempt_fix: ${{ steps.check-attempts.outputs.should_attempt }}
      attempt_count: ${{ steps.check-attempts.outputs.attempt_count }}
      branch: ${{ steps.get-branch.outputs.branch }}

    steps:
      - name: Get branch information
        id: get-branch
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const headBranch = context.payload.workflow_run.head_branch;
            const headSha = context.payload.workflow_run.head_sha;

            console.log(`Failed workflow run: ${runId}`);
            console.log(`Branch: ${headBranch}`);
            console.log(`Commit: ${headSha}`);

            core.setOutput('branch', headBranch);
            core.setOutput('sha', headSha);
            core.setOutput('run_id', runId);

      - name: Check self-healing attempts
        id: check-attempts
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.get-branch.outputs.branch }}';
            const maxAttempts = 3;

            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: branch,
              per_page: 10
            });

            let attemptCount = 0;
            for (const commit of commits) {
              if (commit.commit.message.includes('[jules-fix]') ||
                  commit.commit.message.includes('[self-healing]')) {
                attemptCount++;
              }
            }

            console.log(`Self-healing attempts on ${branch}: ${attemptCount}/${maxAttempts}`);

            const shouldAttempt = attemptCount < maxAttempts;
            core.setOutput('should_attempt', shouldAttempt);
            core.setOutput('attempt_count', attemptCount);

  fetch-logs:
    name: Fetch Build Logs
    runs-on: ubuntu-latest
    needs: analyze-failure
    if: needs.analyze-failure.outputs.should_attempt_fix == 'true'
    permissions:
      actions: read

    outputs:
      error_logs: ${{ steps.get-logs.outputs.logs }}
      error_summary: ${{ steps.get-logs.outputs.summary }}

    steps:
      - name: Download workflow logs
        id: get-logs
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;

            try {
              const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });

              const failedJobs = jobs.jobs.filter(job => job.conclusion === 'failure');
              let errorLogs = [];
              let errorSummary = [];

              for (const job of failedJobs) {
                console.log(`Failed job: ${job.name}`);

                try {
                  const { data: logs } = await github.rest.actions.downloadJobLogsForWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    job_id: job.id
                  });

                  const logLines = logs.split('\n');
                  const errorLines = logLines.filter(line =>
                    line.toLowerCase().includes('error') ||
                    line.toLowerCase().includes('failed') ||
                    line.toLowerCase().includes('exception')
                  ).slice(-100);

                  errorLogs.push({
                    job: job.name,
                    errors: errorLines
                  });

                  errorSummary.push(`Job "${job.name}": ${errorLines.length} error lines`);
                } catch (e) {
                  console.log(`Could not fetch logs for job ${job.id}: ${e.message}`);
                }
              }

              core.setOutput('logs', JSON.stringify(errorLogs));
              core.setOutput('summary', errorSummary.join('\n'));

            } catch (e) {
              console.log(`Error fetching logs: ${e.message}`);
              core.setOutput('logs', '[]');
              core.setOutput('summary', 'Could not fetch error logs');
            }

  jules-fix:
    name: Jules Auto-Fix
    runs-on: ubuntu-latest
    needs: [analyze-failure, fetch-logs]
    if: needs.analyze-failure.outputs.should_attempt_fix == 'true'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Validate Jules API key
        id: validate-key
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          if [ -z "$JULES_API_KEY" ]; then
            echo "::error::JULES_API_KEY secret is not configured"
            echo "valid=false" >> $GITHUB_OUTPUT
          else
            echo "Jules API key is configured"
            echo "valid=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Jules to fix CI failure
        id: jules-fix
        if: steps.validate-key.outputs.valid == 'true'
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          ERROR_LOGS: ${{ needs.fetch-logs.outputs.error_logs }}
          ERROR_SUMMARY: ${{ needs.fetch-logs.outputs.error_summary }}
          BRANCH: ${{ needs.analyze-failure.outputs.branch }}
          ATTEMPT: ${{ needs.analyze-failure.outputs.attempt_count }}
          REPO: ${{ github.repository }}
        run: |
          echo "Triggering Jules to fix CI failure..."
          echo "Branch: $BRANCH"
          echo "Attempt: $((ATTEMPT + 1))/3"
          echo "Error summary: $ERROR_SUMMARY"

          # Build the fix prompt with error context (properly escaped for JSON)
          ERROR_CONTEXT=$(echo "$ERROR_LOGS" | jq -r '
            .[] | "Job: \(.job)\nErrors:\n\(.errors | join("\n"))\n---"
          ' 2>/dev/null || echo "Could not parse error logs")

          ATTEMPT_NUM=$((ATTEMPT + 1))

          # Create prompt using heredoc to avoid YAML parsing issues
          PROMPT=$(cat <<'PROMPT_EOF'
          CI pipeline has failed. Fix the errors and make the build pass.

          ## Error Context
          ERROR_PLACEHOLDER

          ## Instructions
          1. Analyze the error logs
          2. Identify the root cause
          3. Fix the code
          4. Ensure tests pass
          5. Ensure linting passes

          Focus on:
          * Fixing the immediate error first
          * Not introducing new issues
          * Keeping changes minimal
          PROMPT_EOF
          )

          # Replace placeholder with actual error context
          PROMPT="${PROMPT/ERROR_PLACEHOLDER/$ERROR_CONTEXT}"

          # Build JSON payload with proper escaping using jq
          PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT" \
            --arg source "sources/$REPO" \
            --arg branch "$BRANCH" \
            --arg title "[jules-fix] Fix CI failure (attempt $ATTEMPT_NUM/3)" \
            '{
              prompt: $prompt,
              sourceContext: {
                source: $source,
                githubRepoContext: {
                  startingBranch: $branch
                }
              },
              automationMode: "AUTO_CREATE_PR",
              title: $title,
              requirePlanApproval: false
            }')

          echo "Sending request to Jules API..."

          # Retry logic for transient failures
          MAX_RETRIES=3
          RETRY_DELAY=5
          RESPONSE=""

          for i in $(seq 1 $MAX_RETRIES); do
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              "https://jules.googleapis.com/v1alpha/sessions" \
              -H "X-Goog-Api-Key: $JULES_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            echo "HTTP Status: $HTTP_CODE (attempt $i/$MAX_RETRIES)"

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              RESPONSE="$BODY"
              break
            elif [ "$HTTP_CODE" -ge 500 ] || [ "$HTTP_CODE" -eq 429 ]; then
              echo "Retryable error, waiting ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            else
              RESPONSE="$BODY"
              break
            fi
          done

          echo "Jules response: $RESPONSE"

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.name // empty')

          if [ -n "$SESSION_ID" ] && [ "$SESSION_ID" != "null" ]; then
            echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
            echo "Jules session created: $SESSION_ID"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message // .message // "Unknown error"')
            echo "error=$ERROR" >> $GITHUB_OUTPUT
            echo "Failed to create Jules session: $ERROR"
          fi

      - name: Wait for Jules
        if: steps.jules-fix.outputs.success == 'true'
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          SESSION_ID: ${{ steps.jules-fix.outputs.session_id }}
        run: |
          echo "Waiting for Jules to complete fix..."

          for i in {1..60}; do
            RESPONSE=$(curl -s \
              "https://jules.googleapis.com/v1alpha/$SESSION_ID" \
              -H "X-Goog-Api-Key: $JULES_API_KEY")

            STATUS=$(echo "$RESPONSE" | jq -r '.state // "UNKNOWN"')
            echo "Status: $STATUS (check $i/60)"

            if [ "$STATUS" = "COMPLETED" ]; then
              echo "Jules completed the fix!"
              PR_URL=$(echo "$RESPONSE" | jq -r '.outputPullRequestUrl // empty')
              if [ -n "$PR_URL" ] && [ "$PR_URL" != "null" ]; then
                echo "Fix PR: $PR_URL"
                echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
              fi
              break
            elif [ "$STATUS" = "FAILED" ]; then
              echo "Jules failed to fix the issue"
              FAILURE_REASON=$(echo "$RESPONSE" | jq -r '.failureReason // "Unknown"')
              echo "Failure reason: $FAILURE_REASON"
              break
            fi

            sleep 10
          done

      - name: Post status comment
        uses: actions/github-script@v7
        env:
          JULES_SUCCESS: ${{ steps.jules-fix.outputs.success }}
          JULES_ERROR: ${{ steps.jules-fix.outputs.error }}
          SESSION_ID: ${{ steps.jules-fix.outputs.session_id }}
          ATTEMPT: ${{ needs.analyze-failure.outputs.attempt_count }}
        with:
          script: |
            const branch = '${{ needs.analyze-failure.outputs.branch }}';
            const success = process.env.JULES_SUCCESS === 'true';
            const sessionId = process.env.SESSION_ID;
            const error = process.env.JULES_ERROR;
            const attempt = parseInt(process.env.ATTEMPT) + 1;

            // Find associated PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (prs.length === 0) {
              console.log('No open PR found for this branch');
              return;
            }

            const pr = prs[0];
            let body;

            if (success) {
              body = `## Jules Self-Healing

            **Attempt:** ${attempt}/3
            **Status:** Jules is working on a fix

            **Session:** \`${sessionId}\`

            Jules has analyzed the CI failure and is implementing a fix. A new PR or commit will be created shortly.

            [View Jules Session](https://jules.google/)

            ---
            *Powered by [Google Jules](https://jules.google/)*`;
            } else {
              body = `## Jules Self-Healing

            **Attempt:** ${attempt}/3
            **Status:** Could not start Jules

            **Error:** ${error || 'Unknown error'}

            Please check:
            1. Jules GitHub App is installed
            2. \`JULES_API_KEY\` secret is configured
            3. Repository is connected in Jules

            ---
            *Powered by [Google Jules](https://jules.google/)*`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body
            });

  escalate:
    name: Escalate to Human
    runs-on: ubuntu-latest
    needs: analyze-failure
    if: needs.analyze-failure.outputs.should_attempt_fix == 'false'
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Create escalation issue
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ needs.analyze-failure.outputs.branch }}';
            const attemptCount = '${{ needs.analyze-failure.outputs.attempt_count }}';

            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI Failure: Jules exhausted attempts on ${branch}`,
              body: `## Self-Healing Limit Reached

            Jules has made ${attemptCount} attempts to fix CI failures on branch \`${branch}\` without success.

            **Manual intervention required.**

            ### Details
            - **Branch:** \`${branch}\`
            - **Failed Workflow:** [View Run](${context.payload.workflow_run.html_url})
            - **Jules Attempts:** ${attemptCount}/3

            ### Next Steps
            1. Review the failed workflow logs
            2. Check Jules sessions at https://jules.google/
            3. Apply manual fixes
            4. Push changes to trigger CI

            ${prs.length > 0 ? `### Related PR\n- #${prs[0].number}` : ''}

            ---
            *Created by self-healing pipeline*`,
              labels: ['ci-failure', 'needs-attention']
            });

            console.log(`Created escalation issue #${issue.number}`);

            if (prs.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs[0].number,
                body: `## Jules Self-Healing Exhausted

            Jules has made ${attemptCount}/3 fix attempts without success.

            **Manual intervention required.**

            Escalation issue: #${issue.number}`
              });
            }
