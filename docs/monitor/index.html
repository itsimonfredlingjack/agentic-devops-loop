<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Visual representation of our AI-driven development workflow">
  <title>Agentic Loop Monitor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Background colors */
      --bg-deep: #050810;
      --bg-primary: #0a0f1a;
      --bg-secondary: #111827;
      --bg-elevated: #1a2236;
      --bg-card: rgba(255, 255, 255, 0.02);

      /* Border colors */
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-glow: rgba(100, 200, 255, 0.15);

      /* Text colors */
      --text-primary: #f0f4f8;
      --text-secondary: #94a3b8;
      --text-label: #64748b;
      --text-muted: #475569;

      /* Node colors - vivid orbital palette */
      --color-jira: #3b82f6;
      --color-claude: #f59e0b;
      --color-github: #a78bfa;
      --color-ci: #10b981;
      --color-jules: #ec4899;
      --color-merge: #06b6d4;

      /* Status colors */
      --status-done: #10b981;
      --status-active: #f59e0b;
      --status-pending: #334155;

      /* Typography */
      --font-sans: 'Outfit', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
    }

    body {
      font-family: var(--font-sans);
      background: radial-gradient(ellipse at 50% 0%, #0f172a 0%, var(--bg-deep) 70%);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ========== POWERED BY BADGE ========== */
    .header-titles {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .powered-badge {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .powered-label {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    .powered-stack {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tech-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .tech-chip:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: var(--border-glow);
      transform: translateY(-1px);
    }

    .tech-chip[data-tech="ralph"]:hover {
      border-color: rgba(16, 185, 129, 0.4);
      box-shadow: 0 2px 12px rgba(16, 185, 129, 0.15);
    }

    .tech-chip[data-tech="mcp"]:hover {
      border-color: rgba(6, 182, 212, 0.4);
      box-shadow: 0 2px 12px rgba(6, 182, 212, 0.15);
    }

    .tech-chip[data-tech="hooks"]:hover {
      border-color: rgba(245, 158, 11, 0.4);
      box-shadow: 0 2px 12px rgba(245, 158, 11, 0.15);
    }

    .tech-chip[data-tech="healing"]:hover {
      border-color: rgba(236, 72, 153, 0.4);
      box-shadow: 0 2px 12px rgba(236, 72, 153, 0.15);
    }

    .tech-chip[data-tech="n8n"]:hover {
      border-color: rgba(255, 107, 107, 0.4);
      box-shadow: 0 2px 12px rgba(255, 107, 107, 0.15);
    }

    .tech-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .tech-chip[data-tech="ralph"] .tech-dot {
      background: var(--color-ci);
      box-shadow: 0 0 6px var(--color-ci);
    }

    .tech-chip[data-tech="mcp"] .tech-dot {
      background: var(--color-merge);
      box-shadow: 0 0 6px var(--color-merge);
    }

    .tech-chip[data-tech="hooks"] .tech-dot {
      background: var(--color-claude);
      box-shadow: 0 0 6px var(--color-claude);
    }

    .tech-chip[data-tech="healing"] .tech-dot {
      background: var(--color-jules);
      box-shadow: 0 0 6px var(--color-jules);
    }

    .tech-chip[data-tech="n8n"] .tech-dot {
      background: #ff6b6b;
      box-shadow: 0 0 6px #ff6b6b;
    }

    /* Staggered pulse animation for tech dots */
    .tech-chip[data-tech="ralph"] .tech-dot { animation: dot-pulse 3s ease-in-out infinite 0s; }
    .tech-chip[data-tech="mcp"] .tech-dot { animation: dot-pulse 3s ease-in-out infinite 0.5s; }
    .tech-chip[data-tech="hooks"] .tech-dot { animation: dot-pulse 3s ease-in-out infinite 1s; }
    .tech-chip[data-tech="healing"] .tech-dot { animation: dot-pulse 3s ease-in-out infinite 1.5s; }
    .tech-chip[data-tech="n8n"] .tech-dot { animation: dot-pulse 3s ease-in-out infinite 2s; }

    @keyframes dot-pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.8; }
    }

    .tech-name {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: color 0.2s;
    }

    .tech-chip:hover .tech-name {
      color: var(--text-primary);
    }

    @media (max-width: 768px) {
      .powered-badge {
        margin-top: 4px;
      }
      
      .powered-stack {
        gap: 4px;
      }
      
      .header {
        flex-wrap: wrap;
      }
      
      .header-titles {
        gap: 4px;
      }
    }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(180deg, rgba(10, 15, 26, 0.95) 0%, rgba(10, 15, 26, 0.8) 100%);
      border-bottom: 1px solid var(--border-subtle);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 42px;
      height: 42px;
      background: conic-gradient(from 0deg, var(--color-jira), var(--color-claude), var(--color-ci), var(--color-jules), var(--color-merge), var(--color-jira));
      border-radius: 12px;
      position: relative;
      animation: logo-spin 20s linear infinite;
    }

    @keyframes logo-spin {
      to { filter: hue-rotate(360deg); }
    }

    .logo::after {
      content: '';
      position: absolute;
      inset: 3px;
      background: var(--bg-primary);
      border-radius: 9px;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      padding: 10px 20px;
      border-radius: 100px;
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      background: var(--status-done);
      border-radius: 50%;
      box-shadow: 0 0 16px var(--status-done);
      animation: pulse 2s ease-in-out infinite;
    }

    .status-dot.paused {
      background: var(--status-active);
      box-shadow: 0 0 16px var(--status-active);
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(0.85); opacity: 0.6; }
    }

    /* ========== MAIN LAYOUT ========== */
    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 48px;
      max-width: 1440px;
      width: 100%;
      margin: 0 auto;
      padding: 32px 56px;
      align-items: start;
    }

    @media (max-width: 1200px) {
      .main {
        grid-template-columns: 1fr;
        gap: 40px;
        padding: 32px 24px;
      }
    }

    /* ========== ORBITAL CONTAINER ========== */
    .orbital-container {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      position: relative;
      cursor: pointer;
      padding-top: 0;
    }

    .orbital-svg {
      width: 500px;
      height: 500px;
    }

    /* Single progress ring - track (subtle background) */
    .progress-track-ring {
      fill: none;
      stroke: rgba(100, 116, 139, 0.12);
      stroke-width: 4;
    }

    /* Single progress ring - fill (gradient, animates) */
    .progress-ring {
      fill: none;
      stroke: url(#progressGradient);
      stroke-width: 4;
      stroke-linecap: round;
      transform-origin: center;
      transform: rotate(-90deg);
      transition: stroke-dashoffset 1.5s ease-in-out;
    }

    /* Node base styling */
    .node {
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .node:hover {
      transform: scale(1.08);
    }

    .node-bg {
      fill: var(--bg-secondary);
      stroke: var(--border-subtle);
      stroke-width: 2;
      transition: all 0.8s ease-in-out;
    }

    .node-icon {
      color: var(--text-muted);
      transition: all 0.4s;
    }

    .node-label {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      fill: var(--text-label);
      letter-spacing: 0.02em;
      transition: all 0.4s;
    }

    /* Active node - 18% larger with glow */
    .node.active .node-bg {
      fill: var(--node-color);
      stroke: var(--node-color);
      filter: drop-shadow(0 0 24px var(--node-glow));
    }

    .node.active .node-icon {
      color: var(--bg-deep);
    }

    .node.active .node-label {
      fill: var(--text-primary);
      font-weight: 600;
    }

    /* Done node state */
    .node.done .node-bg {
      fill: var(--node-color);
      stroke: var(--node-color);
      opacity: 0.65;
    }

    .node.done .node-icon {
      color: var(--bg-deep);
      opacity: 0.85;
    }

    /* Orbiting progress marker - slow & smooth */
    .orbit-marker {
      filter: drop-shadow(0 0 16px currentColor);
      transition:
        fill 0.6s ease-in-out,
        cx 1.8s ease-in-out,
        cy 1.8s ease-in-out;
    }

    .orbit-marker-glow {
      fill: none;
      stroke-width: 2;
      opacity: 0.5;
      animation: marker-ring-pulse 2s ease-out infinite;
      transition:
        cx 1.8s ease-in-out,
        cy 1.8s ease-in-out,
        stroke 0.6s ease-in-out;
    }

    @keyframes marker-ring-pulse {
      0% { r: 8; opacity: 0.6; }
      100% { r: 24; opacity: 0; }
    }

    /* Center trigger node - ALIVE! */
    .trigger-node {
      cursor: pointer;
      transform-origin: 250px 250px;
      animation: trigger-scale 2s ease-in-out infinite;
    }

    @keyframes trigger-scale {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .trigger-bg {
      fill: url(#triggerGradient);
      stroke: rgba(59, 130, 246, 0.5);
      stroke-width: 2;
      filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.6));
      animation: trigger-glow 2s ease-in-out infinite;
    }

    @keyframes trigger-glow {
      0%, 100% {
        filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.4));
        stroke: rgba(59, 130, 246, 0.4);
      }
      50% {
        filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.8));
        stroke: rgba(6, 182, 212, 0.7);
      }
    }

    .trigger-prompt {
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 700;
      fill: #ffffff;
    }

    .trigger-label {
      font-family: var(--font-mono);
      font-size: 10px;
      fill: var(--color-jira);
      letter-spacing: 0.02em;
      font-weight: 500;
    }

    /* Pulse ring that expands on task start */
    .trigger-pulse-ring {
      fill: none;
      stroke: url(#triggerGradient);
      stroke-width: 3;
      opacity: 0;
      pointer-events: none;
    }

    .trigger-pulse-ring.active {
      animation: pulse-expand 1.5s ease-out forwards;
    }

    @keyframes pulse-expand {
      0% {
        r: 24;
        opacity: 0.8;
        stroke-width: 4;
      }
      100% {
        r: 120;
        opacity: 0;
        stroke-width: 1;
      }
    }

    /* Connection lines */
    .trigger-line, .fetch-line, .return-line {
      pointer-events: none;
    }

    .connection-label {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .connection-label-small {
      font-family: var(--font-mono);
      font-size: 9px;
      font-style: italic;
      letter-spacing: 0.02em;
    }

    /* Click hint */
    .click-hint {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: var(--text-muted);
      opacity: 0.4;
      transition: opacity 0.3s;
    }

    .orbital-container:hover .click-hint {
      opacity: 0.7;
    }

    /* ════════════════════════════════════════════════════════════════
       Unified Navigation
       ════════════════════════════════════════════════════════════════ */
    .nav-tabs {
      display: flex;
      align-items: center;
      gap: 0;
      margin-left: auto;
      margin-right: auto;
    }

    .nav-tab {
      position: relative;
      padding: 8px 16px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 150ms ease;
    }

    .nav-tab:hover {
      color: var(--text-primary);
    }

    .nav-tab.active {
      color: #58a6ff;
    }

    .nav-tab::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 16px;
      right: 16px;
      height: 2px;
      background: #58a6ff;
      transform: scaleX(0);
      transform-origin: center;
      transition: transform 150ms ease;
    }

    .nav-tab.active::after {
      transform: scaleX(1);
    }

    .nav-tab:hover::after {
      transform: scaleX(1);
      opacity: 0.5;
    }

    /* ========== SIDE PANEL ========== */
    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: fit-content;
      max-height: calc(100vh - 160px);
    }

    .panel-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s;
    }

    .panel-card:hover {
      border-color: var(--border-glow);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    /* Event Log panel - takes most space */
    .panel-card--events {
      flex: 1;
      min-height: 280px;
      max-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .panel-card--events .event-log {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    /* Compact panels for Active Step and Current Task */
    .panel-card--compact {
      flex: 0 0 auto;
      padding: 16px 20px;
    }

    .panel-card--compact .section-label {
      margin-bottom: 12px;
    }

    .section-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-label);
      margin-bottom: 16px;
    }

    /* Current Task */
    .task-id {
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--color-jira);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .task-title {
      font-size: 18px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .task-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-status span:first-child {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .task-timer {
      font-family: var(--font-mono);
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    /* Active Step */
    .active-step {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .step-marker {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 18px;
      font-weight: 600;
      color: var(--bg-deep);
      box-shadow: 0 4px 20px var(--step-shadow);
      transition: all 0.4s;
    }

    .step-info h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .step-info p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Progress bar */
    .progress-track {
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--color-jira), var(--color-merge));
      border-radius: 3px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Event Log */
    .event-log {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .event-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      transition: all 0.3s;
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .event-marker {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .event-item.done .event-marker {
      background: var(--status-done);
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
      color: var(--bg-deep);
    }

    .event-item.done { color: var(--text-secondary); }

    .event-item.active .event-marker {
      background: var(--status-active);
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
      animation: glow-pulse 1.5s ease-in-out infinite;
    }

    .event-item.active {
      color: var(--text-primary);
      font-weight: 500;
    }

    @keyframes glow-pulse {
      0%, 100% { box-shadow: 0 0 12px rgba(245, 158, 11, 0.6); }
      50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.9); }
    }

    .event-item.pending .event-marker {
      background: var(--status-pending);
    }

    .event-item.pending { color: var(--text-muted); }

    /* Footer */
    .footer {
      background: rgba(10, 15, 26, 0.6);
      border-top: 1px solid var(--border-subtle);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.2s;
    }

    .footer a:hover { color: var(--text-primary); }

    /* Responsive */
    @media (max-width: 768px) {
      .header { padding: 16px 20px; }
      .header h1 { font-size: 18px; }
      .orbital-svg { width: 340px; height: 340px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo"></div>
      <div class="header-titles">
        <h1>Agentic Loop Monitor</h1>
        <!-- Powered By Badge - shows the hidden tech powering the system -->
        <div class="powered-badge">
          <span class="powered-label">Powered by</span>
          <div class="powered-stack">
            <span class="tech-chip" data-tech="ralph" title="Ralph Wiggum Technique - Autonomous iteration loop">
              <span class="tech-dot"></span>
              <span class="tech-name">Ralph Loop</span>
            </span>
            <span class="tech-chip" data-tech="mcp" title="Model Context Protocol - Serena, Context7, Playwright">
              <span class="tech-dot"></span>
              <span class="tech-name">MCP</span>
            </span>
            <span class="tech-chip" data-tech="hooks" title="PreToolUse & Stop hooks for security and control">
              <span class="tech-dot"></span>
              <span class="tech-name">Hooks</span>
            </span>
            <span class="tech-chip" data-tech="healing" title="Self-healing CI with auto-retry">
              <span class="tech-dot"></span>
              <span class="tech-name">Self-Heal</span>
            </span>
            <a href="https://n8n.io" target="_blank" rel="noopener" class="tech-chip" data-tech="n8n" title="n8n - Workflow automation">
              <span class="tech-dot"></span>
              <span class="tech-name">n8n</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
      <a href="../guide/" class="nav-tab" data-page="guide">Guide</a>
      <a href="../monitor/" class="nav-tab active" data-page="monitor">Monitor</a>
    </nav>

    <div class="status-indicator">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Running</span>
    </div>
  </header>

  <main class="main">
    <section class="orbital-container" id="orbitalContainer">
      <svg class="orbital-svg" viewBox="0 0 500 500">
        <defs>
          <!-- Progress gradient (follows the loop colors) -->
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#3b82f6"/>
            <stop offset="20%" stop-color="#f59e0b"/>
            <stop offset="40%" stop-color="#a78bfa"/>
            <stop offset="60%" stop-color="#10b981"/>
            <stop offset="80%" stop-color="#ec4899"/>
            <stop offset="100%" stop-color="#06b6d4"/>
          </linearGradient>

          <!-- Trigger node gradient (blue to cyan - alive!) -->
          <linearGradient id="triggerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#3b82f6"/>
            <stop offset="100%" stop-color="#06b6d4"/>
          </linearGradient>
        </defs>

        <!-- CONNECTION LINES (drawn first, under nodes) -->
        <!-- Line: Center → Claude (trigger initiates to AI) -->
        <line class="trigger-line" x1="250" y1="250" x2="405.88" y2="160" stroke="rgba(245, 158, 11, 0.4)" stroke-width="2"/>
        <text x="328" y="195" class="connection-label" fill="var(--color-claude)">PROJ-123</text>

        <!-- Dashed line: Claude → Jira (fetch ticket data) -->
        <line class="fetch-line" x1="405.88" y1="160" x2="250" y2="70" stroke="rgba(59, 130, 246, 0.3)" stroke-width="2" stroke-dasharray="6 4"/>
        <text x="340" y="100" class="connection-label-small" fill="var(--text-muted)">fetch</text>

        <!-- Return line: Merge → Center (loop complete) -->
        <line class="return-line" x1="94.12" y1="160" x2="250" y2="250" stroke="rgba(6, 182, 212, 0.3)" stroke-width="1.5" stroke-dasharray="4 3"/>

        <!-- SINGLE progress ring: subtle track -->
        <circle class="progress-track-ring" cx="250" cy="250" r="180"/>

        <!-- SINGLE progress ring: colored fill (animates clockwise) -->
        <circle
          class="progress-ring"
          id="progressRing"
          cx="250"
          cy="250"
          r="180"
          stroke-dasharray="1131"
          stroke-dashoffset="1131"
        />

        <!-- NODE 0: Jira (0° - top, 12 o'clock) -->
        <!-- Math: x = 250 + 180*sin(0°) = 250, y = 250 - 180*cos(0°) = 70 -->
        <g class="node" data-step="0" style="--node-color: var(--color-jira); --node-glow: rgba(59, 130, 246, 0.5)">
          <circle class="node-bg" cx="250" cy="70" r="32"/>
          <g class="node-icon" transform="translate(250, 70)">
            <rect x="-9" y="-11" width="18" height="20" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
            <rect x="-5" y="-15" width="10" height="5" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
            <line x1="-5" y1="-1" x2="5" y2="-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="-5" y1="4" x2="3" y2="4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </g>
          <text x="250" y="26" text-anchor="middle" class="node-label">JIRA</text>
        </g>

        <!-- NODE 1: Claude Code (60° - 2 o'clock) -->
        <!-- Math: x = 250 + 180*sin(60°) = 250 + 155.88 = 405.88, y = 250 - 180*cos(60°) = 250 - 90 = 160 -->
        <g class="node" data-step="1" style="--node-color: var(--color-claude); --node-glow: rgba(245, 158, 11, 0.5)">
          <circle class="node-bg" cx="405.88" cy="160" r="32"/>
          <g class="node-icon" transform="translate(405.88, 160)">
            <path d="M -10 -8 L -4 0 L -10 8" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="0" y1="8" x2="9" y2="8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            <circle cx="6" cy="-2" r="3" fill="currentColor"/>
          </g>
          <text x="452" y="165" text-anchor="start" class="node-label">CLAUDE</text>
        </g>

        <!-- NODE 2: GitHub (120° - 4 o'clock) -->
        <!-- Math: x = 250 + 180*sin(120°) = 405.88, y = 250 - 180*cos(120°) = 250 + 90 = 340 -->
        <g class="node" data-step="2" style="--node-color: var(--color-github); --node-glow: rgba(167, 139, 250, 0.5)">
          <circle class="node-bg" cx="405.88" cy="340" r="32"/>
          <g class="node-icon" transform="translate(405.88, 340)">
            <circle cx="-5" cy="-7" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="5" cy="-2" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="-5" cy="7" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            <line x1="-5" y1="-4" x2="-5" y2="4" stroke="currentColor" stroke-width="2"/>
            <path d="M -5 -2 Q 0 -2 5 1" fill="none" stroke="currentColor" stroke-width="2"/>
          </g>
          <text x="452" y="345" text-anchor="start" class="node-label">GITHUB</text>
        </g>

        <!-- NODE 3: CI/CD (180° - bottom, 6 o'clock) -->
        <!-- Math: x = 250 + 180*sin(180°) = 250, y = 250 - 180*cos(180°) = 250 + 180 = 430 -->
        <g class="node" data-step="3" style="--node-color: var(--color-ci); --node-glow: rgba(16, 185, 129, 0.5)">
          <circle class="node-bg" cx="250" cy="430" r="32"/>
          <g class="node-icon" transform="translate(250, 430)">
            <circle cx="0" cy="0" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
            <g stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <line x1="0" y1="-11" x2="0" y2="-7"/>
              <line x1="0" y1="7" x2="0" y2="11"/>
              <line x1="-11" y1="0" x2="-7" y2="0"/>
              <line x1="7" y1="0" x2="11" y2="0"/>
            </g>
            <polygon points="-2,-3 -2,3 3,0" fill="currentColor"/>
          </g>
          <text x="250" y="476" text-anchor="middle" class="node-label">CI/CD</text>
        </g>

        <!-- NODE 4: Jules Review (240° - 8 o'clock) -->
        <!-- Math: x = 250 + 180*sin(240°) = 250 - 155.88 = 94.12, y = 250 - 180*cos(240°) = 250 + 90 = 340 -->
        <g class="node" data-step="4" style="--node-color: var(--color-jules); --node-glow: rgba(236, 72, 153, 0.5)">
          <circle class="node-bg" cx="94.12" cy="340" r="32"/>
          <g class="node-icon" transform="translate(94.12, 340)">
            <path d="M -12 0 Q 0 -10 12 0 Q 0 10 -12 0" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="0" cy="0" r="4" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="0" cy="0" r="1.5" fill="currentColor"/>
          </g>
          <text x="48" y="345" text-anchor="end" class="node-label">JULES</text>
        </g>

        <!-- NODE 5: Merge (300° - 10 o'clock) -->
        <!-- Math: x = 250 + 180*sin(300°) = 250 - 155.88 = 94.12, y = 250 - 180*cos(300°) = 250 - 90 = 160 -->
        <g class="node" data-step="5" style="--node-color: var(--color-merge); --node-glow: rgba(6, 182, 212, 0.5)">
          <circle class="node-bg" cx="94.12" cy="160" r="32"/>
          <g class="node-icon" transform="translate(94.12, 160)">
            <circle cx="-5" cy="-7" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="5" cy="-7" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="0" cy="7" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M -5 -4 L -5 0 Q -5 3 0 5" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M 5 -4 L 5 0 Q 5 3 0 5" fill="none" stroke="currentColor" stroke-width="2"/>
          </g>
          <text x="48" y="165" text-anchor="end" class="node-label">MERGE</text>
        </g>

        <!-- CENTER TRIGGER NODE -->
        <!-- Pulse ring (expands on task start) -->
        <circle class="trigger-pulse-ring" id="triggerPulseRing" cx="250" cy="250" r="24"/>

        <g class="trigger-node">
          <circle class="trigger-bg" cx="250" cy="250" r="24"/>
          <text x="250" y="255" text-anchor="middle" class="trigger-prompt">&gt;_</text>
          <text x="250" y="285" text-anchor="middle" class="trigger-label">/start-task</text>
        </g>

        <!-- Orbiting marker (moves to active node) -->
        <circle class="orbit-marker-glow" id="markerGlow" cx="250" cy="70" r="8" stroke="var(--color-jira)"/>
        <circle class="orbit-marker" id="orbitMarker" cx="250" cy="70" r="6" fill="var(--color-jira)"/>
      </svg>
      <div class="click-hint">Click or Space to pause</div>
    </section>

    <aside class="side-panel">
      <!-- EVENT LOG first - highest priority, shows real-time activity -->
      <div class="panel-card panel-card--events">
        <div class="section-label">Event Log</div>
        <ul class="event-log" id="eventLog">
          <li class="event-item" data-step="0"><span class="event-marker"></span><span>Fetch Jira ticket</span></li>
          <li class="event-item" data-step="1"><span class="event-marker"></span><span>Claude writes code</span></li>
          <li class="event-item" data-step="2"><span class="event-marker"></span><span>Push to GitHub</span></li>
          <li class="event-item" data-step="3"><span class="event-marker"></span><span>Run CI pipeline</span></li>
          <li class="event-item" data-step="4"><span class="event-marker"></span><span>Jules code review</span></li>
          <li class="event-item" data-step="5"><span class="event-marker"></span><span>Merge to main</span></li>
        </ul>
      </div>

      <!-- ACTIVE STEP second - medium priority -->
      <div class="panel-card panel-card--compact">
        <div class="section-label">Active Step</div>
        <div class="active-step">
          <div class="step-marker" id="stepMarker" style="background: var(--color-jira); --step-shadow: rgba(59, 130, 246, 0.4)">1</div>
          <div class="step-info">
            <h3 id="stepName">Jira Ticket</h3>
            <p id="stepDesc">Reading ticket requirements...</p>
          </div>
        </div>
        <div class="progress-track">
          <div class="progress-fill" id="progressFill" style="width: 10%"></div>
        </div>
      </div>

      <!-- CURRENT TASK last - lowest priority when idle -->
      <div class="panel-card panel-card--compact">
        <div class="section-label">Current Task</div>
        <div class="task-id">PROJ-123</div>
        <div class="task-title">Implement CSV export for report dashboard</div>
        <div class="task-meta">
          <span class="task-status">In Progress</span>
          <span class="task-timer" id="taskTimer">0:00</span>
        </div>
      </div>
    </aside>
  </main>

  <footer class="footer">
    <a href="../guide/">Back to Guide</a>
    <span>Hosted on GitHub Pages</span>
  </footer>

  <script>
    // ════════════════════════════════════════════════════════════════
    // REAL-TIME MONITOR - WebSocket Connected
    // ════════════════════════════════════════════════════════════════

    const RADIUS = 180;
    const CENTER = 250;
    const CIRCUMFERENCE = 2 * Math.PI * RADIUS; // ~1131

    // WebSocket configuration
    const WS_URL = window.location.protocol === 'https:'
      ? `wss://${window.location.host}/ws`
      : `ws://${window.location.host}/ws`;

    // Mathematically precise node positions
    const nodePositions = [
      { x: 250, y: 70 },      // 0°   - Jira (top)
      { x: 405.88, y: 160 },  // 60°  - Claude
      { x: 405.88, y: 340 },  // 120° - GitHub
      { x: 250, y: 430 },     // 180° - CI/CD (bottom)
      { x: 94.12, y: 340 },   // 240° - Jules
      { x: 94.12, y: 160 }    // 300° - Merge
    ];

    const steps = [
      { name: 'Jira Ticket', desc: 'Fetching ticket requirements...', color: '#3b82f6', shadow: 'rgba(59, 130, 246, 0.4)', progress: 16.67 },
      { name: 'Claude Code', desc: 'Writing tests and implementation...', color: '#f59e0b', shadow: 'rgba(245, 158, 11, 0.4)', progress: 33.33 },
      { name: 'GitHub PR', desc: 'Pushing code and creating PR...', color: '#a78bfa', shadow: 'rgba(167, 139, 250, 0.4)', progress: 50 },
      { name: 'CI Pipeline', desc: 'Running tests and validation...', color: '#10b981', shadow: 'rgba(16, 185, 129, 0.4)', progress: 66.67 },
      { name: 'Jules Review', desc: 'AI reviewing code changes...', color: '#ec4899', shadow: 'rgba(236, 72, 153, 0.4)', progress: 83.33 },
      { name: 'Merge', desc: 'Merging to main branch!', color: '#06b6d4', shadow: 'rgba(6, 182, 212, 0.4)', progress: 100 }
    ];

    let currentStep = -1; // -1 = idle/waiting
    let isPaused = false;
    let elapsedSeconds = 0;
    let ws = null;
    let reconnectAttempts = 0;
    let timerInterval = null;

    // DOM elements
    const orbitMarker = document.getElementById('orbitMarker');
    const markerGlow = document.getElementById('markerGlow');
    const progressRing = document.getElementById('progressRing');
    const triggerPulseRing = document.getElementById('triggerPulseRing');
    const nodes = document.querySelectorAll('.node');
    const stepMarker = document.getElementById('stepMarker');
    const stepName = document.getElementById('stepName');
    const stepDesc = document.getElementById('stepDesc');
    const progressFill = document.getElementById('progressFill');
    const eventLog = document.getElementById('eventLog');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const taskTimer = document.getElementById('taskTimer');
    const taskId = document.querySelector('.task-id');
    const taskTitle = document.querySelector('.task-title');

    // ════════════════════════════════════════════════════════════════
    // WebSocket Connection
    // ════════════════════════════════════════════════════════════════

    function connectWebSocket() {
      console.log('Connecting to WebSocket:', WS_URL);
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        console.log('WebSocket connected');
        reconnectAttempts = 0;
        updateConnectionStatus('connected');
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected');
        updateConnectionStatus('disconnected');
        // Reconnect with exponential backoff
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
        reconnectAttempts++;
        setTimeout(connectWebSocket, delay);
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };

      ws.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          handleMessage(message);
        } catch (e) {
          console.error('Failed to parse message:', e);
        }
      };
    }

    function updateConnectionStatus(status) {
      if (status === 'connected') {
        statusDot.style.background = 'var(--status-done)';
        statusDot.style.boxShadow = '0 0 16px var(--status-done)';
      } else {
        statusDot.style.background = '#ef4444';
        statusDot.style.boxShadow = '0 0 16px #ef4444';
        statusText.textContent = 'Disconnected';
      }
    }

    // ════════════════════════════════════════════════════════════════
    // Message Handlers
    // ════════════════════════════════════════════════════════════════

    function handleMessage(message) {
      console.log('Received:', message.type, message);

      switch (message.type) {
        case 'init':
          handleInit(message.data);
          break;
        case 'task_update':
          handleTaskUpdate(message.data);
          break;
        case 'event':
          handleEvent(message.data);
          break;
        case 'status':
          handleStatusChange(message.status);
          break;
        case 'reset':
          handleReset();
          break;
        case 'pong':
          // Heartbeat response
          break;
      }
    }

    function handleInit(data) {
      console.log('Initializing with state:', data);

      // Set elapsed time from server
      elapsedSeconds = data.elapsed_seconds || 0;
      updateTimer();

      // Start local timer
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (!isPaused && currentStep >= 0) {
          elapsedSeconds++;
          updateTimer();
        }
      }, 1000);

      // Handle task state
      if (data.task) {
        handleTaskUpdate(data.task);
      } else {
        setIdleState();
      }

      // Handle status
      if (data.status === 'paused') {
        isPaused = true;
        statusDot.classList.add('paused');
        statusText.textContent = 'Paused';
      } else if (data.status === 'running') {
        isPaused = false;
        statusDot.classList.remove('paused');
        statusText.textContent = 'Running';
      } else {
        setIdleState();
      }

      // Populate events
      if (data.events && data.events.length > 0) {
        renderEvents(data.events);
      }
    }

    function handleTaskUpdate(task) {
      console.log('Task update:', task);

      // Update task info in side panel
      if (task.task_id) {
        taskId.textContent = task.task_id;
      }
      if (task.title) {
        taskTitle.textContent = task.title;
      }

      // Update step in orbital view
      if (typeof task.step === 'number' && task.step >= 0 && task.step <= 5) {
        const previousStep = currentStep;
        currentStep = task.step;

        // Trigger pulse when starting new task (step 0 from idle)
        if (previousStep === -1 && currentStep === 0) {
          triggerPulse();
        }

        updateOrbitalView(currentStep, task.step_name, task.step_desc);
      }

      // Update status
      if (task.status) {
        const statusMap = {
          'pending': 'Pending',
          'in_progress': 'In Progress',
          'done': 'Complete',
          'failed': 'Failed'
        };
        document.querySelector('.task-status').innerHTML = `
          <span style="
            width: 8px;
            height: 8px;
            background: ${task.status === 'done' ? 'var(--status-done)' : task.status === 'failed' ? '#ef4444' : 'var(--status-active)'};
            border-radius: 50%;
            box-shadow: 0 0 10px ${task.status === 'done' ? 'var(--status-done)' : task.status === 'failed' ? '#ef4444' : 'var(--status-active)'};
          "></span>
          ${statusMap[task.status] || task.status}
        `;
      }

      // Update iteration info if available
      if (task.iteration !== undefined) {
        const iterInfo = task.max_iterations
          ? `Iteration ${task.iteration}/${task.max_iterations}`
          : `Iteration ${task.iteration}`;
        stepDesc.textContent = task.step_desc || iterInfo;
      }

      statusText.textContent = 'Running';
      statusDot.classList.remove('paused');
    }

    function handleEvent(event) {
      console.log('Event:', event);
      addEventToLog(event);
    }

    function handleStatusChange(status) {
      isPaused = status === 'paused';
      statusDot.classList.toggle('paused', isPaused);
      statusText.textContent = isPaused ? 'Paused' : 'Running';
    }

    function handleReset() {
      currentStep = -1;
      elapsedSeconds = 0;
      updateTimer();
      setIdleState();
      clearEventLog();
    }

    // ════════════════════════════════════════════════════════════════
    // UI Update Functions
    // ════════════════════════════════════════════════════════════════

    function setIdleState() {
      currentStep = -1;
      statusText.textContent = 'Waiting';
      statusDot.style.background = 'var(--status-pending)';
      statusDot.style.boxShadow = 'none';

      taskId.textContent = '—';
      taskTitle.textContent = 'Waiting for task...';
      stepMarker.textContent = '?';
      stepMarker.style.background = 'var(--status-pending)';
      stepName.textContent = 'Idle';
      stepDesc.textContent = 'Run /start-task PROJ-XXX to begin';
      progressFill.style.width = '0%';

      // Reset progress ring
      progressRing.style.strokeDashoffset = CIRCUMFERENCE;

      // Reset all nodes to pending
      nodes.forEach(node => {
        node.classList.remove('active', 'done');
        node.querySelector('.node-bg').setAttribute('r', '32');
      });

      // Hide orbit marker
      orbitMarker.style.opacity = '0.3';
      markerGlow.style.opacity = '0';

      // Reset event log to pending state
      const items = eventLog.querySelectorAll('.event-item');
      items.forEach(item => {
        item.classList.remove('done', 'active');
        item.classList.add('pending');
        item.querySelector('.event-marker').textContent = '';
      });
    }

    function updateOrbitalView(index, customName, customDesc) {
      if (index < 0 || index > 5) return;

      const step = steps[index];
      const pos = nodePositions[index];

      // Show orbit marker
      orbitMarker.style.opacity = '1';
      markerGlow.style.opacity = '1';

      // Move orbiting marker to active node
      orbitMarker.setAttribute('cx', pos.x);
      orbitMarker.setAttribute('cy', pos.y);
      orbitMarker.style.fill = step.color;
      markerGlow.setAttribute('cx', pos.x);
      markerGlow.setAttribute('cy', pos.y);
      markerGlow.style.stroke = step.color;

      // Update progress ring (fills clockwise from top)
      const completedFraction = (index + 1) / steps.length;
      const dashOffset = CIRCUMFERENCE * (1 - completedFraction);
      progressRing.style.strokeDashoffset = dashOffset;

      // Update nodes
      nodes.forEach((node, i) => {
        node.classList.remove('active', 'done');
        const bg = node.querySelector('.node-bg');

        if (i < index) {
          node.classList.add('done');
          bg.setAttribute('r', '32');
        } else if (i === index) {
          node.classList.add('active');
          bg.setAttribute('r', '38'); // 18% larger when active
        } else {
          bg.setAttribute('r', '32');
        }
      });

      // Update side panel
      stepMarker.style.background = step.color;
      stepMarker.style.setProperty('--step-shadow', step.shadow);
      stepMarker.textContent = index + 1;
      stepName.textContent = customName || step.name;
      stepDesc.textContent = customDesc || step.desc;
      progressFill.style.width = step.progress + '%';

      // Update event log steps
      const items = eventLog.querySelectorAll('.event-item');
      items.forEach((item, i) => {
        item.classList.remove('done', 'active', 'pending');
        const marker = item.querySelector('.event-marker');

        if (i < index) {
          item.classList.add('done');
          marker.textContent = '✓';
        } else if (i === index) {
          item.classList.add('active');
          marker.textContent = '';
        } else {
          item.classList.add('pending');
          marker.textContent = '';
        }
      });
    }

    function updateTimer() {
      const mins = Math.floor(elapsedSeconds / 60);
      const secs = elapsedSeconds % 60;
      taskTimer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Trigger pulse animation from center
    function triggerPulse() {
      triggerPulseRing.classList.remove('active');
      void triggerPulseRing.offsetWidth;
      triggerPulseRing.classList.add('active');
    }

    // ════════════════════════════════════════════════════════════════
    // Event Log Functions
    // ════════════════════════════════════════════════════════════════

    function addEventToLog(event) {
      // Create new event item
      const li = document.createElement('li');
      li.className = 'event-item';

      // Color based on event type
      const typeColors = {
        success: 'var(--status-done)',
        error: '#ef4444',
        warning: 'var(--status-active)',
        info: 'var(--color-jira)'
      };
      const color = typeColors[event.event_type] || 'var(--text-secondary)';

      // Icon based on event type
      const typeIcons = {
        success: '✓',
        error: '✕',
        warning: '!',
        info: '→'
      };
      const icon = typeIcons[event.event_type] || '•';

      li.innerHTML = `
        <span class="event-marker" style="background: ${color}; box-shadow: 0 0 8px ${color}; color: var(--bg-deep); font-size: 8px;">${icon}</span>
        <span style="flex: 1;">${event.message}</span>
        <span style="font-family: var(--font-mono); font-size: 11px; color: var(--text-muted);">${event.source || ''}</span>
      `;

      // Insert at top of custom events section (after the 6 step items)
      const stepItems = eventLog.querySelectorAll('.event-item[data-step]');
      if (stepItems.length > 0) {
        // Insert after last step item
        stepItems[stepItems.length - 1].after(li);
      } else {
        eventLog.prepend(li);
      }

      // Animate in
      li.style.opacity = '0';
      li.style.transform = 'translateX(-10px)';
      requestAnimationFrame(() => {
        li.style.transition = 'all 0.3s ease';
        li.style.opacity = '1';
        li.style.transform = 'translateX(0)';
      });

      // Keep max 20 custom events (not counting step items)
      const customEvents = eventLog.querySelectorAll('.event-item:not([data-step])');
      if (customEvents.length > 14) {
        customEvents[customEvents.length - 1].remove();
      }
    }

    function renderEvents(events) {
      // Clear existing custom events
      const customEvents = eventLog.querySelectorAll('.event-item:not([data-step])');
      customEvents.forEach(e => e.remove());

      // Add events (newest first)
      events.slice().reverse().forEach(event => {
        addEventToLog(event);
      });
    }

    function clearEventLog() {
      const customEvents = eventLog.querySelectorAll('.event-item:not([data-step])');
      customEvents.forEach(e => e.remove());
    }

    // ════════════════════════════════════════════════════════════════
    // Pause/Resume (local toggle that also notifies server)
    // ════════════════════════════════════════════════════════════════

    function togglePause() {
      isPaused = !isPaused;
      statusDot.classList.toggle('paused', isPaused);
      const runLabel = demoRunning ? 'Demo' : 'Running';
      statusText.textContent = isPaused ? 'Paused' : runLabel;

      // Notify server
      if (ws && ws.readyState === WebSocket.OPEN) {
        // Server doesn't have a toggle endpoint, but we can send a message
        // For now, just toggle locally
      }
    }

    document.getElementById('orbitalContainer').addEventListener('click', togglePause);
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        togglePause();
      }
    });

    // ════════════════════════════════════════════════════════════════
    // Heartbeat to keep connection alive
    // ════════════════════════════════════════════════════════════════

    setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping' }));
      }
    }, 30000);

    // ════════════════════════════════════════════════════════════════
    // Active Tab Detection
    // ════════════════════════════════════════════════════════════════

    function initNavTabs() {
      const currentPage = window.location.pathname.includes('/monitor/') ? 'monitor' : 'guide';
      const navTabs = document.querySelectorAll('.nav-tab');
      navTabs.forEach(tab => {
        if (tab.dataset.page === currentPage) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
    }

    // ════════════════════════════════════════════════════════════════
    // DEMO MODE - Simulates the full loop on static hosting
    // ════════════════════════════════════════════════════════════════

    let demoRunning = false;
    let demoTimeout = null;

    const demoEvents = [
      { step: 0, events: [
        { event_type: 'info', message: 'Fetching PROJ-123 from Jira...', source: 'jira' },
        { event_type: 'success', message: 'Ticket loaded: Implement CSV export', source: 'jira' }
      ]},
      { step: 1, events: [
        { event_type: 'info', message: 'Reading acceptance criteria...', source: 'claude' },
        { event_type: 'info', message: 'Writing failing test (RED phase)', source: 'claude' },
        { event_type: 'success', message: 'Tests written, implementing code...', source: 'claude' },
        { event_type: 'success', message: 'All tests passing (GREEN phase)', source: 'claude' }
      ]},
      { step: 2, events: [
        { event_type: 'info', message: 'Staging changes...', source: 'git' },
        { event_type: 'info', message: 'Committing: PROJ-123: Add CSV export', source: 'git' },
        { event_type: 'success', message: 'PR #42 created successfully', source: 'github' }
      ]},
      { step: 3, events: [
        { event_type: 'info', message: 'Running lint checks...', source: 'ci' },
        { event_type: 'success', message: 'Lint passed (0 errors)', source: 'ci' },
        { event_type: 'info', message: 'Running test suite...', source: 'ci' },
        { event_type: 'success', message: 'Tests passed (24/24, 94% coverage)', source: 'ci' }
      ]},
      { step: 4, events: [
        { event_type: 'info', message: 'Jules reviewing PR #42...', source: 'jules' },
        { event_type: 'info', message: 'Analyzing code quality...', source: 'jules' },
        { event_type: 'success', message: 'Review approved - LGTM', source: 'jules' }
      ]},
      { step: 5, events: [
        { event_type: 'info', message: 'Merging PR #42 to main...', source: 'git' },
        { event_type: 'success', message: 'Merged! Branch cleaned up.', source: 'github' },
        { event_type: 'success', message: 'Jira PROJ-123 transitioned to Done', source: 'jira' }
      ]}
    ];

    function startDemo() {
      if (demoRunning) return;
      demoRunning = true;
      elapsedSeconds = 0;

      // Start timer
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (!isPaused) {
          elapsedSeconds++;
          updateTimer();
        }
      }, 1000);

      // Update status to running
      statusDot.style.background = 'var(--status-done)';
      statusDot.style.boxShadow = '0 0 16px var(--status-done)';
      statusDot.classList.remove('paused');
      statusText.textContent = 'Demo';

      // Update task info
      taskId.textContent = 'PROJ-123';
      taskTitle.textContent = 'Implement CSV export for report dashboard';

      // Show orbit marker
      orbitMarker.style.opacity = '1';
      markerGlow.style.opacity = '1';

      // Fire center pulse
      triggerPulse();

      // Run loop
      runDemoStep(0);
    }

    function runDemoStep(stepIndex) {
      if (!demoRunning) return;

      if (stepIndex >= steps.length) {
        // Loop complete - pause briefly, then reset and restart
        demoTimeout = setTimeout(() => {
          resetDemo();
          demoTimeout = setTimeout(() => {
            startDemo();
          }, 2000);
        }, 3000);
        return;
      }

      // Wait if paused
      if (isPaused) {
        demoTimeout = setTimeout(() => runDemoStep(stepIndex), 200);
        return;
      }

      // Activate this step
      currentStep = stepIndex;
      const step = steps[stepIndex];
      updateOrbitalView(stepIndex, step.name, step.desc);
      statusText.textContent = 'Demo';

      // Fire events for this step with staggered timing
      const stepEvents = demoEvents[stepIndex].events;
      stepEvents.forEach((evt, i) => {
        setTimeout(() => {
          if (demoRunning && !isPaused) {
            addEventToLog(evt);
          }
        }, 800 * (i + 1));
      });

      // Move to next step after events finish
      const stepDuration = 800 * (stepEvents.length + 1) + 1200;
      demoTimeout = setTimeout(() => {
        runDemoStep(stepIndex + 1);
      }, stepDuration);
    }

    function resetDemo() {
      currentStep = -1;
      elapsedSeconds = 0;
      updateTimer();

      // Reset nodes
      nodes.forEach(node => {
        node.classList.remove('active', 'done');
        node.querySelector('.node-bg').setAttribute('r', '32');
      });

      // Reset progress
      progressRing.style.strokeDashoffset = CIRCUMFERENCE;
      progressFill.style.width = '0%';

      // Reset orbit marker to start position
      orbitMarker.setAttribute('cx', nodePositions[0].x);
      orbitMarker.setAttribute('cy', nodePositions[0].y);
      orbitMarker.style.fill = steps[0].color;
      markerGlow.setAttribute('cx', nodePositions[0].x);
      markerGlow.setAttribute('cy', nodePositions[0].y);
      markerGlow.style.stroke = steps[0].color;

      // Reset step info
      stepMarker.style.background = 'var(--status-pending)';
      stepMarker.textContent = '?';
      stepName.textContent = 'Restarting...';
      stepDesc.textContent = 'New loop cycle starting';

      // Clear custom events from log
      clearEventLog();

      // Reset event log items to pending
      const items = eventLog.querySelectorAll('.event-item[data-step]');
      items.forEach(item => {
        item.classList.remove('done', 'active');
        item.classList.add('pending');
        item.querySelector('.event-marker').textContent = '';
      });
    }

    function stopDemo() {
      demoRunning = false;
      if (demoTimeout) {
        clearTimeout(demoTimeout);
        demoTimeout = null;
      }
    }

    // Detect if we're on static hosting (GitHub Pages) or no WS server
    function isStaticHosting() {
      const host = window.location.hostname;
      return host.includes('github.io') ||
             host.includes('netlify') ||
             host.includes('vercel') ||
             host === '' ||
             window.location.protocol === 'file:';
    }

    // ════════════════════════════════════════════════════════════════
    // Initialize
    // ════════════════════════════════════════════════════════════════

    initNavTabs();
    setIdleState();

    if (isStaticHosting()) {
      // On static hosting: skip WebSocket, run demo mode
      console.log('Static hosting detected - starting demo mode');
      setTimeout(startDemo, 800);
    } else {
      // Real server: connect via WebSocket
      connectWebSocket();

      // Fallback: if WebSocket doesn't connect within 5s, start demo
      setTimeout(() => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.log('WebSocket unavailable - falling back to demo mode');
          startDemo();
        }
      }, 5000);
    }
  </script>
</body>
</html>
