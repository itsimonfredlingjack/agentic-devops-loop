name: Self-Healing Pipeline

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  check-failure:
    name: Check if healing needed
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    outputs:
      should_heal: ${{ steps.check.outputs.should_heal }}
      branch: ${{ steps.check.outputs.branch }}
    steps:
      - name: Check healing attempts
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.workflow_run.head_branch;
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: branch,
              per_page: 10
            });

            const healingAttempts = commits.filter(c =>
              c.commit.message.includes('[self-healing]')
            ).length;

            core.setOutput('should_heal', healingAttempts < 3);
            core.setOutput('branch', branch);

  heal:
    name: Jules Self-Healing
    needs: check-failure
    if: needs.check-failure.outputs.should_heal == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-failure.outputs.branch }}
          fetch-depth: 0

      - name: Run Jules to fix CI failure
        uses: google/jules-invoke@v1
        with:
          task: |
            The CI pipeline failed. Analyze the errors and fix them.

            Focus on:
            - Linting errors (run auto-fix)
            - Formatting issues
            - Simple type errors

            Do NOT fix:
            - Failing tests
            - Complex architectural issues

            Make minimal changes.

      - name: Commit fixes
        run: |
          git config user.name "Jules Bot"
          git config user.email "jules-bot@users.noreply.github.com"

          if ! git diff --quiet; then
            git add -A
            git commit -m "[self-healing] Auto-fix CI errors"
            git push origin ${{ needs.check-failure.outputs.branch }}
          fi

  escalate:
    name: Escalate to Human
    needs: check-failure
    if: needs.check-failure.outputs.should_heal == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ needs.check-failure.outputs.branch }}';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI failure needs manual fix: ${branch}`,
              body: `Self-healing failed after 3 attempts.\n\nBranch: \`${branch}\``,
              labels: ['ci-failure', 'needs-attention']
            });
