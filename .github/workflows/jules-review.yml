name: Jules Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  jules-review:
    name: Google Jules AI Review
    runs-on: ubuntu-latest
    outputs:
      has_critical_issues: ${{ steps.feedback.outputs.has_critical_issues }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr-info
        run: |
          echo "branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT

      - name: Trigger Jules Review
        id: jules
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          # Create Jules session for code review
          RESPONSE=$(curl -s -X POST \
            "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "prompt": "Review this pull request for:\n\n1. **Security vulnerabilities** (OWASP Top 10, injection, XSS, auth issues)\n2. **Performance problems** (N+1 queries, inefficient loops, memory leaks)\n3. **Code quality** (readability, error handling, best practices)\n4. **Bug risks** (edge cases, null checks, race conditions)\n\nProvide specific feedback with file paths and line numbers. Suggest fixes for any critical issues found.",
              "sourceContext": {
                "source": "sources/github/${{ github.repository }}",
                "githubRepoContext": {
                  "startingBranch": "${{ github.head_ref }}"
                }
              },
              "title": "PR Review: ${{ github.event.pull_request.title }}",
              "requirePlanApproval": false
            }')

          echo "Jules response: $RESPONSE"

          # Extract session ID
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.name // empty')

          if [ -n "$SESSION_ID" ]; then
            echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Jules analysis
        if: steps.jules.outputs.success == 'true'
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          SESSION_ID: ${{ steps.jules.outputs.session_id }}
        run: |
          echo "Waiting for Jules to complete analysis..."

          # Poll for completion (max 5 minutes)
          for i in {1..30}; do
            RESPONSE=$(curl -s \
              "https://jules.googleapis.com/v1alpha/$SESSION_ID" \
              -H "X-Goog-Api-Key: $JULES_API_KEY")

            STATUS=$(echo "$RESPONSE" | jq -r '.state // "UNKNOWN"')
            echo "Status: $STATUS"

            if [ "$STATUS" = "COMPLETED" ] || [ "$STATUS" = "FAILED" ]; then
              echo "Jules finished with status: $STATUS"
              break
            fi

            sleep 10
          done

      - name: Get Jules feedback
        if: steps.jules.outputs.success == 'true'
        id: feedback
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          SESSION_ID: ${{ steps.jules.outputs.session_id }}
        run: |
          # Get activities (Jules' analysis results)
          ACTIVITIES=$(curl -s \
            "https://jules.googleapis.com/v1alpha/$SESSION_ID/activities" \
            -H "X-Goog-Api-Key: $JULES_API_KEY")

          echo "activities<<EOF" >> $GITHUB_OUTPUT
          echo "$ACTIVITIES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Check if Jules found critical issues (security vulnerabilities or bugs)
          HAS_CRITICAL=$(echo "$ACTIVITIES" | jq -r '[.activities[]? | select(.severity == "CRITICAL" or .severity == "HIGH")] | length > 0')
          echo "has_critical_issues=$HAS_CRITICAL" >> $GITHUB_OUTPUT

      - name: Post review comment
        uses: actions/github-script@v7
        env:
          JULES_SUCCESS: ${{ steps.jules.outputs.success }}
          JULES_ERROR: ${{ steps.jules.outputs.error }}
          SESSION_ID: ${{ steps.jules.outputs.session_id }}
        with:
          script: |
            const success = process.env.JULES_SUCCESS === 'true';
            const sessionId = process.env.SESSION_ID;
            const error = process.env.JULES_ERROR;

            let body;

            if (success) {
              body = `## ü§ñ Jules Code Review

              Jules has analyzed this pull request.

              **Session:** \`${sessionId}\`

              Review in progress - Jules will create comments on specific issues found.

              ---
              *Powered by [Google Jules](https://jules.google/)*`;
            } else {
              body = `## ü§ñ Jules Code Review

              ‚ö†Ô∏è Could not start Jules review.

              **Error:** ${error || 'Unknown error'}

              Please check:
              1. Jules GitHub App is installed on this repo
              2. \`JULES_API_KEY\` secret is configured
              3. Repository is connected in Jules web app

              ---
              *Powered by [Google Jules](https://jules.google/)*`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

  jules-auto-fix:
    name: Jules Auto-Fix (Critical Issues)
    runs-on: ubuntu-latest
    needs: jules-review
    if: needs.jules-review.outputs.has_critical_issues == 'true'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Jules fix
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          curl -s -X POST \
            "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "prompt": "Fix the critical issues found in the code review. Focus on security vulnerabilities and bugs first.",
              "sourceContext": {
                "source": "sources/github/${{ github.repository }}",
                "githubRepoContext": {
                  "startingBranch": "${{ github.head_ref }}"
                }
              },
              "automationMode": "AUTO_CREATE_PR",
              "title": "Auto-fix: Critical issues from PR #${{ github.event.pull_request.number }}"
            }'
