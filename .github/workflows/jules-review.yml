name: Jules Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
      - develop

# Minimal permissions by default
permissions:
  contents: read

jobs:
  code-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: write        # For fix-commits
      pull-requests: write   # For comments
      issues: write          # For creating issues on major problems

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.js
            **/*.ts
            **/*.tsx
            **/*.jsx
            **/*.py
            **/*.java
            **/*.go
            **/*.rs
            **/*.rb
            **/*.php
            **/*.cs
            **/*.cpp
            **/*.c
            **/*.h

      - name: Setup Node.js
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        if: steps.changed-files.outputs.any_changed == 'true'
        run: npm install -g @anthropic-ai/claude-code

      - name: Create review prompt file
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          cat > /tmp/review-prompt.md << 'PROMPT_EOF'
          Review the changed files in this PR for:

          ## Security (OWASP Top 10)
          - SQL Injection, XSS vulnerabilities
          - Insecure authentication
          - Sensitive data exposure

          ## Performance
          - Inefficient loops (O(nÂ²) where O(n) is possible)
          - N+1 query patterns
          - Memory leaks

          ## Code Style
          - Follow project linting rules
          - Proper error handling

          For each issue, specify:
          - Severity: critical, warning, or info
          - File and line number
          - Description and suggested fix

          End with either "APPROVED" or "CHANGES_REQUESTED" and a summary.

          Changed files to review:
          PROMPT_EOF

          echo "$CHANGED_FILES" >> /tmp/review-prompt.md

      - name: Run Claude Code Review
        if: steps.changed-files.outputs.any_changed == 'true'
        id: claude-review
        env:
          CLAUDE_CODE_USE_BEDROCK: ${{ secrets.CLAUDE_CODE_USE_BEDROCK }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
        run: |
          # Run Claude Code in non-interactive mode with the review prompt
          REVIEW_OUTPUT=$(claude-code --print "$(cat /tmp/review-prompt.md)" 2>/dev/null || echo "REVIEW_SKIPPED: Claude Code not configured")

          # Save output for next steps
          echo "$REVIEW_OUTPUT" > /tmp/review-output.txt

          # Check if review contains critical issues
          if echo "$REVIEW_OUTPUT" | grep -qi "critical"; then
            echo "has_critical=true" >> $GITHUB_OUTPUT
          else
            echo "has_critical=false" >> $GITHUB_OUTPUT
          fi

          # Check approval status
          if echo "$REVIEW_OUTPUT" | grep -qi "APPROVED"; then
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "approved=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Review Comment
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        env:
          REVIEW_APPROVED: ${{ steps.claude-review.outputs.approved }}
          HAS_CRITICAL: ${{ steps.claude-review.outputs.has_critical }}
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;

            let reviewOutput;
            try {
              reviewOutput = fs.readFileSync('/tmp/review-output.txt', 'utf8');
            } catch (e) {
              reviewOutput = 'Review output not available';
            }

            const approved = process.env.REVIEW_APPROVED === 'true';
            const hasCritical = process.env.HAS_CRITICAL === 'true';

            let statusEmoji = approved ? 'âœ…' : (hasCritical ? 'ðŸš¨' : 'âš ï¸');
            let statusText = approved ? 'LGTM' : (hasCritical ? 'Critical Issues Found' : 'Changes Requested');

            // Truncate if too long
            if (reviewOutput.length > 60000) {
              reviewOutput = reviewOutput.substring(0, 60000) + '\n\n... (truncated)';
            }

            const body = `## ðŸ¤– Jules Code Review

            **Status:** ${statusEmoji} ${statusText}

            <details>
            <summary>Review Details</summary>

            ${reviewOutput}

            </details>

            ---
            *Powered by Claude Code CLI*
            *Configure in \`.github/workflows/jules-review.yml\`*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });

      - name: Auto-fix Critical Issues
        if: steps.changed-files.outputs.any_changed == 'true' && steps.claude-review.outputs.has_critical == 'true'
        env:
          CLAUDE_CODE_USE_BEDROCK: ${{ secrets.CLAUDE_CODE_USE_BEDROCK }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
        run: |
          # Ask Claude Code to fix critical issues
          claude-code --print "Fix the critical security and performance issues identified in the review. Only fix critical issues, not warnings. Make minimal changes." || true

          # Check if there are changes to commit
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit and push fixes
          git config user.name "Jules Bot"
          git config user.email "jules-bot@users.noreply.github.com"
          git add -A
          git commit -m "fix: Auto-fix critical issues found by Jules

          Automatic fixes applied by Claude Code review.
          Please verify the changes are correct."
          git push

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript, python
        continue-on-error: true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        continue-on-error: true
